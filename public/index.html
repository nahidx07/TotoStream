<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toto Stream - Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #CCF02F; --bg: #000; --card: #1C1C1E; --text: #FFF; --dim: #8E8E93; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; margin: 0; overflow: hidden; }

        /* Loader Screen */
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.5s; }
        #loader img { width: 100px; height: 100px; border-radius: 20px; margin-bottom: 20px; animation: pulse 1.5s infinite; object-fit: cover; }
        @keyframes pulse { 0% { transform: scale(0.9); opacity: 0.6; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.9); opacity: 0.6; } }

        /* App Layout */
        .app-content { height: 100vh; display: flex; flex-direction: column; opacity: 0; transition: 0.8s; }
        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 100; }
        .logo-header { height: 35px; border-radius: 5px; }
        
        /* Section Management */
        .section { flex: 1; overflow-y: auto; padding: 10px 20px 120px; display: none; }
        .section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Typography */
        .greet-text { color: var(--dim); font-size: 11px; font-weight: bold; letter-spacing: 1.5px; }
        h1, h2, h3 { margin: 5px 0; }

        /* Points Badge */
        .points-badge { background: var(--card); padding: 8px 15px; border-radius: 20px; color: var(--primary); font-weight: bold; font-size: 14px; border: 1px solid #333; }

        /* Banner & Cards */
        .banner { width: 100%; height: 210px; border-radius: 30px; overflow: hidden; position: relative; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .banner img { width: 100%; height: 100%; object-fit: cover; }
        .banner-overlay { position: absolute; inset: 0; background: linear-gradient(transparent, rgba(0,0,0,0.9)); padding: 20px; display: flex; flex-direction: column; justify-content: flex-end; }
        .card { background: var(--card); border-radius: 25px; overflow: hidden; margin-bottom: 10px; }
        .card img { width: 100%; height: 110px; object-fit: cover; }

        /* Form Inputs */
        .edit-input { width: 100%; background: var(--card); border: 1px solid #333; padding: 14px; border-radius: 15px; color: #fff; margin-bottom: 15px; font-size: 15px; }
        .btn-premium { background: var(--primary); color: #000; border: none; width: 100%; padding: 15px; border-radius: 15px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .btn-premium:active { transform: scale(0.97); }

        /* Rank List */
        .rank-card { background: var(--card); padding: 12px; border-radius: 20px; display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
        .rank-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #333; }

        /* Bottom Nav */
        nav { position: fixed; bottom: 25px; left: 20px; right: 20px; background: rgba(28,28,30,0.9); backdrop-filter: blur(20px); display: flex; justify-content: space-around; padding: 15px 5px; border-radius: 35px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 15px 35px rgba(0,0,0,0.6); }
        .nav-item { color: #666; text-decoration: none; font-size: 10px; text-align: center; transition: 0.3s; font-weight: bold; }
        .nav-item.active { color: var(--primary); }
        .nav-item svg { width: 22px; height: 22px; display: block; margin: 0 auto 5px; fill: currentColor; }

        /* Video Overlay */
        #videoOverlay { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; }
        .close-vid { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); color: #fff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 2100; }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loader">
        <img id="loadLogo" src="">
        <div style="color: var(--primary); font-weight: bold; letter-spacing: 2px; font-size: 14px;">TOTO STREAM</div>
    </div>

    <div class="app-content" id="app">
        <header>
            <div class="user-greet">
                <span class="greet-text">WELCOME BACK</span>
                <h2 id="uNameHeader" style="font-size: 18px;">USER</h2>
            </div>
            <div class="points-badge">üî• <span id="uPoints">0</span></div>
        </header>

        <!-- Section: Home -->
        <div id="home" class="section active">
            <div id="topBanner"></div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 12px; font-weight: bold; color: var(--dim);">
                <span>FOR YOU</span>
                <span style="color: var(--primary)">See all</span>
            </div>
            <div id="streamGrid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;"></div>
        </div>

        <!-- Section: Leaderboard -->
        <div id="leaderboard" class="section">
            <h2 style="margin-bottom: 20px;">Legends Board üèÜ</h2>
            <div id="rankList"></div>
        </div>

        <!-- Section: Referral -->
        <div id="referral" class="section">
            <div style="background: var(--card); padding: 35px 25px; border-radius: 35px; text-align: center; border: 1px solid #333;">
                <div style="font-size: 60px; margin-bottom: 10px;">üéÅ</div>
                <h3>Refer & Earn Points</h3>
                <p style="color: var(--dim); font-size: 14px;">Invite friends and get <b style="color:var(--primary)">500 Points</b> instantly when they join!</p>
                <div id="refLink" style="background:#000; padding:18px; border-radius:15px; font-size:11px; margin:25px 0; color:var(--primary); word-break: break-all; border: 1px dashed var(--primary);">Loading Link...</div>
                <button class="btn-premium" onclick="copyRef()">Copy Referral Link</button>
            </div>
        </div>

        <!-- Section: Profile -->
        <div id="profile" class="section">
            <div style="text-align: center; margin-bottom: 35px;">
                <img id="pAvatar" src="" style="width:110px; height:110px; border-radius:50%; border:4px solid var(--primary); object-fit: cover;">
                <h2 id="pName" style="margin-top:15px;">User Name</h2>
                <p id="pId" style="color:var(--dim); font-size: 13px;">ID: ---</p>
            </div>
            <div style="padding: 5px;">
                <label style="color: var(--dim); font-size: 12px; margin-left: 5px;">Full Name</label>
                <input type="text" id="editName" class="edit-input">
                <label style="color: var(--dim); font-size: 12px; margin-left: 5px;">Email Address</label>
                <input type="email" id="editEmail" class="edit-input" placeholder="Enter your email">
                <label style="color: var(--dim); font-size: 12px; margin-left: 5px;">Phone Number</label>
                <input type="tel" id="editPhone" class="edit-input" placeholder="+88017xxxxxxxx">
                <button class="btn-premium" style="margin-top: 10px;" onclick="saveProfile()">Save Changes</button>
            </div>
        </div>

        <nav>
            <a href="#" class="nav-item active" onclick="showSec('home', this)">
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home
            </a>
            <a href="#" class="nav-item" onclick="showSec('leaderboard', this)">
                <svg viewBox="0 0 24 24"><path d="M19 5h-2V3H7v2H5c-1.1 0-2 .9-2 2v1c0 2.55 1.92 4.63 4.39 4.94A5.01 5.01 0 0011 15.9V19H7v2h10v-2h-4v-3.1a5.01 5.01 0 003.61-2.96C19.08 12.63 21 10.55 21 8V7c0-1.1-.9-2-2-2z"/></svg>Rank
            </a>
            <a href="#" class="nav-item" onclick="showSec('referral', this)">
                <svg viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1a2.5 2.5 0 00-5 0c0 .35.07.69.18 1H11c.11-.31.18-.65.18-1a2.5 2.5 0 00-5 0c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2z"/></svg>Refer
            </a>
            <a href="#" class="nav-item" onclick="showSec('profile', this)">
                <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>Profile
            </a>
        </nav>
    </div>

    <!-- Video Player Overlay -->
    <div id="videoOverlay">
        <div class="close-vid" onclick="closePlayer()">√ó</div>
        <iframe id="vFrame" src="" width="100%" height="45%" frameborder="0" style="margin-top:25%" allowfullscreen></iframe>
        <div style="padding:25px;">
            <h2 id="vTitle" style="color:white; margin:0; font-size: 22px;">Title</h2>
            <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
                <span style="color:red; font-weight:bold; font-size:14px;">‚óè LIVE</span>
                <span style="color:var(--dim); font-size:14px;">‚Ä¢ Earning 10 pts every minute</span>
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCn72TD-I1yI6-7oCCGlx1Mudh_ZlT7138",
            authDomain: "totostream.firebaseapp.com",
            projectId: "totostream",
            appId: "1:22142190592:web:e937438ca67f37cbbcc4e5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        tg.expand();

        async function initApp() {
            try {
                // Load App Settings
                const settings = await db.collection('settings').doc('app').get();
                if(settings.exists) {
                    const sData = settings.data();
                    document.getElementById('loadLogo').src = sData.logo;
                    document.getElementById('loadLogo').style.display = 'block';
                }

                const tgUser = tg.initDataUnsafe.user || { id: 12345, first_name: "Guest", username: "guest" };
                const uid = tgUser.id.toString();

                // Load User Profile from DB
                const userDoc = await db.collection('users').doc(uid).get();
                if(userDoc.exists) {
                    const data = userDoc.data();
                    document.getElementById('uNameHeader').innerText = data.name.split(' ')[0].toUpperCase();
                    document.getElementById('uPoints').innerText = data.points;
                    document.getElementById('pAvatar').src = data.photo;
                    document.getElementById('pName').innerText = data.name;
                    document.getElementById('pId').innerText = "ID: " + uid;
                    document.getElementById('editName').value = data.name;
                    document.getElementById('editEmail').value = data.email || "";
                    document.getElementById('editPhone').value = data.phone || "";
                    // Referral Link (Bot Link + startapp parameter)
                    document.getElementById('refLink').innerText = `https://t.me/YourBotName?startapp=${uid}`;
                } else {
                    document.getElementById('pName').innerText = tgUser.first_name;
                    document.getElementById('refLink').innerText = "Restart bot to sync account.";
                }

                loadStreams();
                loadLeaderboard();

                // Close Loader
                setTimeout(() => {
                    document.getElementById('loader').style.opacity = '0';
                    setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                    document.getElementById('app').style.opacity = '1';
                }, 2500);

            } catch(e) { console.error(e); }
        }

        function showSec(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            el.classList.add('active');
        }

        async function loadStreams() {
            const snap = await db.collection('streams').orderBy('createdAt', 'desc').get();
            const grid = document.getElementById('streamGrid');
            const banner = document.getElementById('topBanner');
            grid.innerHTML = ''; let count = 0;
            
            snap.forEach(doc => {
                const s = doc.data();
                if(count === 0) {
                    banner.innerHTML = `
                        <div class="banner" onclick="openPlayer('${s.streamUrl}', '${s.title}')">
                            <img src="${s.thumbnail}">
                            <div class="banner-overlay">
                                <span style="color:var(--primary); font-size:10px; font-weight:bold;">LATEST LIVE</span>
                                <h2 style="margin:5px 0;">${s.title}</h2>
                            </div>
                        </div>`;
                } else {
                    grid.innerHTML += `
                        <div class="card" onclick="openPlayer('${s.streamUrl}', '${s.title}')">
                            <img src="${s.thumbnail}">
                            <div style="padding:12px; font-size:13px; font-weight:bold;">${s.title}</div>
                        </div>`;
                }
                count++;
            });
        }

        async function loadLeaderboard() {
            const snap = await db.collection('users').orderBy('points', 'desc').limit(20).get();
            const list = document.getElementById('rankList');
            list.innerHTML = ''; let i = 1;
            snap.forEach(doc => {
                const u = doc.data();
                list.innerHTML += `
                    <div class="rank-card">
                        <b style="width:25px; color:var(--primary)">${i++}</b>
                        <img src="${u.photo}" class="rank-img">
                        <div style="flex:1"><b>${u.name}</b><br><small style="color:var(--dim)">@${u.username}</small></div>
                        <b style="color:var(--primary)">${u.points}</b>
                    </div>`;
            });
        }

        let pTimer;
        function openPlayer(url, title) {
            if(!url) return;
            document.getElementById('videoOverlay').style.display = 'block';
            document.getElementById('vFrame').src = url;
            document.getElementById('vTitle').innerText = title;
            // Point accumulation logic (10 points every minute)
            pTimer = setInterval(async () => {
                const uid = tg.initDataUnsafe.user.id.toString();
                await db.collection('users').doc(uid).update({
                    points: firebase.firestore.FieldValue.increment(10)
                });
                // Update UI points locally to feel fast
                const curr = parseInt(document.getElementById('uPoints').innerText);
                document.getElementById('uPoints').innerText = curr + 10;
            }, 60000);
        }

        function closePlayer() {
            document.getElementById('videoOverlay').style.display = 'none';
            document.getElementById('vFrame').src = '';
            clearInterval(pTimer);
        }

        async function saveProfile() {
            const uid = tg.initDataUnsafe.user.id.toString();
            const n = document.getElementById('editName').value;
            const e = document.getElementById('editEmail').value;
            const p = document.getElementById('editPhone').value;
            await db.collection('users').doc(uid).update({ name: n, email: e, phone: p });
            tg.showAlert("Profile updated! ‚ú®");
            document.getElementById('pName').innerText = n;
        }

        function copyRef() {
            const link = document.getElementById('refLink').innerText;
            navigator.clipboard.writeText(link);
            tg.showAlert("Invite link copied! Share with friends to earn points. üéÅ");
        }

        initApp();
    </script>
</body>
</html>
